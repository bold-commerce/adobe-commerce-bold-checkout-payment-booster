name: Pull Request
run-name: Run Integration Tests

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    paths-ignore:
      - '.github/dependabot.*'
      - '**/*.md'
      - '**/*.txt'

permissions:
  contents: read

jobs:
  setup-and-run:
    strategy:
      fail-fast: false
      matrix:
        include:
          # - php-version : "7.2"
          #   magento-version: "2.3.5-p2"
          #   composer-version: "v1"
          #   maria-db-version: "10.4"
          - php-version: "7.4"
            magento-version: "2.4.3-p3"
            composer-version: "v2"
            maria-db-version: "10.4"
#          - php-version: "8.1"
#            magento-version: "2.4.4-p13"
#            composer-version: "v2"
#            maria-db-version: "10.6"
#          - php-version: "8.1"
#            magento-version: "2.4.5-p12"
#            composer-version: "v2"
#            maria-db-version: "10.6"
#          - php-version: "8.2"
#            magento-version: "2.4.6-p10"
#            composer-version: "v2"
#            maria-db-version: "10.6"
#          - php-version: "8.3"
#            magento-version: "2.4.7-p5"
#            composer-version: "v2"
#            maria-db-version: "10.6"
          - php-version: "8.4"
            magento-version: "2.4.8"
            composer-version: "v2"
            maria-db-version: "10.6"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    services:
      mariadb:
        image: mariadb:${{ matrix.maria-db-version }}
        env:
          MYSQL_PASSWORD: root
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: magento_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      redis:
        image: redis:7.2
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli -h localhost -p 6379 ping" --health-interval=10s --health-timeout=5s --health-retries=10
      opensearch:
        image: opensearchproject/opensearch:2.12.0
        env:
          OPENSEARCH_INITIAL_ADMIN_PASSWORD: magento2Root!
          discovery.type: single-node
          DISABLE_SECURITY_PLUGIN: true
        ports:
          - 9200:9200
        options: --health-cmd="curl --silent --show-error --fail -ku admin:magento2Root! http://localhost:9200/_cluster/health || exit 1" --health-interval=10s --health-timeout=10s --health-retries=10
      rabbitmq:
        image: rabbitmq:3.13
        ports:
          - 5672:5672
        options: --health-cmd="rabbitmq-diagnostics -q ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: run the test
      working-directory: integration-pipeline-test
      run: |
        vendor/bin/phpunit -vvv -c $(pwd)/dev/tests/integration/phpunit.xml vendor/bold-commerce/module-checkout-payment-booster/Test/Integration
